{% extends "layout.html" %}
{% set title = "AgroVision Nepal | AI Crop Identifier" %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h2 class="fw-bold mb-0">AI Crop Identifier</h2>
    <div class="text-muted small">
      Upload a crop image and let AI analyze leaf texture, structure & color.
    </div>
  </div>
  <a class="btn btn-outline-light btn-sm" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
</div>

<div class="row g-4">

  <!-- LEFT: Upload -->
  <div class="col-lg-5">
    <div class="card card-agro shadow-sm">
      <div class="card-body">

        <h6 class="fw-bold mb-3">Upload Crop Image</h6>

        <form id="uploadForm"
              method="POST"
              action="{{ url_for('identify_crop') }}"
              enctype="multipart/form-data">

          <div class="mb-3">
            <input class="form-control" type="file" name="image" accept="image/*" required>
            <div class="text-muted small mt-2">
              Best results: close leaf photo, good light, plain background.
            </div>
          </div>

          <div class="d-grid">
            <button class="btn btn-success" type="submit">Analyze Image</button>
          </div>
        </form>

        <div id="loadingSpinner" class="text-center mt-4 d-none">
          <div class="spinner-border text-success" role="status"></div>
          <div class="small text-muted mt-2">AI analyzing‚Ä¶</div>
          <div class="progress mt-2" style="height: 8px;">
            <div id="analyzeBar" class="progress-bar bg-success" style="width: 0%;"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- RIGHT: Result -->
  <div class="col-lg-7">

    {% if result %}
      {% set conf = result.confidence if result.confidence is not none else 0 %}

      <div class="card card-agro shadow-sm">
        <div class="card-body">

          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="icon-badge">ü§ñ</div>
            <div class="fw-semibold">AI Analysis Result</div>
          </div>

          {% if result.image_url %}
            <div class="mb-3 text-center">
              <img src="{{ result.image_url }}"
                   class="img-fluid rounded-4 border border-light border-opacity-10"
                   style="max-height: 240px;">
            </div>
          {% endif %}

          {% if result.is_plant == false %}
            <div class="alert alert-warning mb-0">
              This image does not strongly resemble a crop/leaf.
              Please upload a clearer plant image (close leaf photo, good light).
            </div>

          {% else %}

            <div class="mb-2">
              <div class="fw-bold fs-5">Detected Crop: {{ result.crop }}</div>
              <div class="text-muted small">Scientific Name: {{ result.scientific }}</div>
            </div>

            <div class="mb-2 small text-muted">
              Model Label: {{ result.raw_label }}
            </div>

            <div class="mb-3">
              <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-success" style="width: {{ conf }}%;"></div>
              </div>
              <div class="small text-muted mt-1">Confidence: {{ conf }}%</div>
            </div>

            {% if result.suggestions %}
              <div class="mb-3">
                <div class="small text-muted mb-1">Suggested Crops:</div>
                {% for s in result.suggestions %}
                  <span class="badge text-bg-secondary me-1">{{ s }}</span>
                {% endfor %}
              </div>
            {% endif %}

            <!-- ‚úÖ If confidence is low, ask user to confirm (demo-safe, product-like) -->
            {% if conf < 35 %}
              <div class="alert alert-warning mt-3">
                AI is not fully confident. Please confirm the crop to continue.
              </div>

              <form method="POST" action="{{ url_for('confirm_crop') }}">
                <div class="input-group">
                  <select class="form-select" name="crop_name" required>
                    <option value="">Confirm crop</option>
                    <option>Rice</option>
                    <option>Wheat</option>
                    <option>Maize</option>
                    <option>Potato</option>
                    <option>Tomato</option>
                  </select>
                  <button class="btn btn-success" type="submit">Confirm</button>
                </div>
                <div class="text-muted small mt-2">
                  This improves accuracy in real deployments using farmer feedback.
                </div>
              </form>

            {% else %}

              <div class="d-grid mt-3">
                <a class="btn btn-success" href="{{ url_for('growth', crop_name=result.crop) }}">
                  View Growth Plan ‚Üí
                </a>
              </div>

            {% endif %}

          {% endif %}

        </div>
      </div>

    {% else %}

      <div class="card card-agro shadow-sm">
        <div class="card-body text-muted">
          Upload an image to see AI prediction results here.
        </div>
      </div>

    {% endif %}

  </div>
</div>

<script>
  const form = document.getElementById("uploadForm");
  const spinner = document.getElementById("loadingSpinner");
  const bar = document.getElementById("analyzeBar");

  form?.addEventListener("submit", () => {
    spinner.classList.remove("d-none");

    let p = 0;
    const t = setInterval(() => {
      p += Math.floor(Math.random() * 12) + 6;
      if (p >= 100) { p = 100; clearInterval(t); }
      if (bar) bar.style.width = p + "%";
    }, 120);
  });
</script>

{% endblock %}
